3 도커스웜 (p189 ~ p231)

---

## 3.1 도커 스웜을 사용하는 이유

도커 엔진을 구동하다가 서버의 자원이 부족할경우? 스케일 업, 스케일 아웃

가장 많이 사용하는 방법은 여러 대의 서버를 클러스터로 만들어 자원을 병렬로 확장

그러나 여러대의 서버를 하나의 자원 풀로 만드는 것은 쉬운 작업이 아니다. ServiceDiscovery, 스케줄러, 로드밸랜서 등의 문제가 있다. 이러한 문제를 해결하기 위한 오픈소스중 대표적인것이 쿠버네티스, 도커 스웜이다.

## 3.2 스웜 모드

스웜 모드는 별도의 설치 없이 도커 엔진 자체에 내장되어있음.

> 서버 클러스터링을 할 때는 반드시 각 서버의 시각을 NTP 등의 툴을 이용해 동기화해야 한다. 서버 간에 설정된 시각이 다를 경우 옛강치 못한 오류가 발생할 수 있기 때문.
> 

### 3.2.1 도커 스웜 모드의 구조

스웜 모드는 매니저 노드와 워커노드로 구성

워커 노드는 실제로 컨테이너가 생성되고 관리되는 서버이고 매니저 노드는 워커 노드를 관리하기 위한 도커 서버

매니저 노드에도 컨테이너가 생성될 수 있으며, 매니저 노드는 기본적으로 워커 노드의 역할을 포함

매니저 노드는 1개 이상이 있어야 하지만 워커 노드는 없을 수도 있다. 매니저 노드가 워커 노드 역할을 할 수 있어 매니저 노드 만으로 클러스터를 구축할 수 있다. 하지만 구분해서 사용하는 것을 권장

운영환경에서는 매니저노드를 다중화하는 것을 권장(부하분산등의 이유). 그러나 매니저 수를 늘린다고 스웜 클러스터의 성능이 좋아지는 것은 아님

스웜 매니저는 가능한 한 홀수 개로 구성 하는 것을 권장. 네트워크 파이셔닝, 데이터 일관성을 위한 투표 등의 이유

### 3.2.2 도커 스웜 모드 클러스터 구축

```bash
manager 192.168.0.100
worker 192.168.0.101
worker 192.168.0.102

[manager] docker swarm init --advertise-addr 192.168.0.100
#해당 명령어 입력시 토큰값 출력해줌

[worker] docker swarm join \
--token 토큰값 \
192.168.0.100:2377

[manager] docker node ls #노드 확인 가능

[manager] docker swarm join-token manager #매니저로 참가하기 위한 토큰 확인

[manager] docker swarm join-token --rotate manager #토큰 갱신

[worker] docker swarm leave #스웜 해제
[manager] docker node rm [hostname] #떠난 노드 삭제
[manager] docker swarm leave --force #매니저 노드 스웜 해제시에는 --force

[manager] docker node promote worker #worker노드 매니저로 변경
[manager] docker node demote manager #manager노드 워커로 변경
```

> 스웜 매니저는 2377포트를 기본적으로 사용
노드 사이의 통신은 7946/tcp, 7946/udp
스웜이 사용하는 네트워크인 ingress 오버레이 네트워크에 4789/tcp, 4789/udp사용
> 

> 매니저 노드는 일반적인 매니저 역할을 하는 노드와 리더 역할을 하는 노드로 나뉨
리더 역할의 노드가 장애가 생길경우 Raft Consensus 알고리즘을 통해 새로운 리더 선출
> 

### 3.2.3 스웜 모드 서비스

3.2.3.1 스웜 모드 서비스 개념

스웜모드의 제어 단위는 컨테이너가 아니라 서비스

서비스는 같은 이미지에서 생성된 컨테이너의 집합

서비스내에는 1개 이상의 컨테이너가 존재하며 컨테이너는 Task라고 함

특정 개수에 맞게 함께 생성된 컨테이너를 레플리카라고 하며, 서비스에 설정된 레플리카의 수만큼의 컨테이너가 스웜 클러스터 내에 존재해야 함

스웜은 서비스 컨테이너들의 상태를 확인하다가 서비스 내에 정의된 레플리카 수만큼 컨테이너가 스웜 클러스터에 존재하지 않으면 새로운 컨테이너 레플리카를 생성

서비스는 롤링 업데이트 기능도 제공

> 롤링 업데이트는 여걸 개의 서버, 컨테이너 등으로 구성된 클러스터의 설정이나 데이터 등을 변경하기 위해 하나씩 재시작하는 것을 의미. 롤링 업데이트를 사용하지 않고 모든 서버나 컨테이너를 한번에 재시작하면 제공하는 서비스에 다운 시간이 생기지만 롤링 업데이트를 사용하면 지속적인 서비스 제공가능
> 

3.2.3.2 서비스 생성

👉 서비스 생성 확인 삭제

```bash
[manager] docker service create
[manager] docker service ls
[manager] docker service rm [서비스네임]
```

👉 레플리카 세팅

```sql
[manager] docker service create --name myweb\
--replicas 2 \ #레플리카 갯수 2개로 세팅
-p 80:80 \ #스웜클러스터에 포트 개방
nginx

[manager] docker service scale myweb=4 #레플리카 4개로 변경
```

👉 글로벌 서비스
글로벌 서비스는 스웜클러스터내에서 사용하는 모든 노드에 컨테이너를 하나씩 생성

```bash
[manager] docker service create --name global-web \
--mode global \
nginx
```

3.2.3.3 스웜 모드의 서비스 장애 복구

복제 모드로 설정된 서비스의 컨테이너가 정지하거나 특정 노드가 다운되면 스웜 매니저는 새로운 컨테이너를 생성해 자동으로 이를 복구.

3.2.3.4 서비스 롤링 업데이트

> docekr service ps 명령어에 NAME 항목에 \_ 가 붙어 있는 컨테이너는 어떠한 이유로든 동작을 멈춘 컨테이너로서, 서비스에서의 컨테이너 변경 기록을 나타냄
> 

```bash
[manager] docker service create \
--replicas 4 \
--name myweb3 \
--update-delay 10s \ #레플리카를 10초 단위로 업데이트
--update-parallelism 2 \ #한번에 2개의 컨테이너를 실행
nginx

[manager] docker service rollback myweb3 #업데이트 전으로 롤백도 가능
```

3.2.3.5 서비스 컨테이너에 설정 정보 전달하기: config, secret

👉 secret

비밀번호나 SSH 키 , 인증서 키와 같이 보안에 민감한 데이털르 전송하기 위해 사용

스웜모드에서만 사용가능

👉 config

암호화할 필요없는 설정값들에 사용

스웜모드에서만 사용가능

3.2.3.6 도커 스웜 네트워크

스웜모드는 여러 개의 도커 엔진에 같은 컨테이너를 분산해서 할당하기 때문에 각 도커 데몬의 네트워크가 하나로 묶인, 이른바 네트워크 풀이 필요. 뿐만 아니라 서비스를 외부로 노출했을 때 어느 노드로 접근하더라도 해당 서비스의 컨테이너에 접근할 수 있게 라우팅 기능이 필요

👉 ingress 네트워크

스웜 클러스터를 등록하면 자동으로 등록되는 네트워크

ingress 네트워크는 어떤 스웜노드에 접근하더라도 서비스 내의 컨테이너에 접근할 수 있게 설정하는 라우팅 메시를 구성하고, 서비스 내의 컨테이너에 대한 접근을 라운드 로빈 방식으로 분산하는 로드 밸런싱 기능을 담당

👉 오버레이 네트워크

여러개의 도커 데몬을 하나의 네트워크 풀로 만드는 넽트워크 가상화 기술의 하나

도커에 오버레이 네트워크를 적용하면 여러 도커 데몬에 존재하는 컨테이너가 서로 통신할 수 있다.

👉 docker_gwbridge 네트워크

👉 사용자 정의 오버레이 네트워크

3.2.3.7 서비스 디스커버리

새로 생성된 컨테이너 생성의 발견(Service Discovery) 혹은 없어진 컨테이너의 감지

일반적으로 주키퍼, etcd등의 분산 코디네이터를 외부에 두고 사용해서 해결하지만 스웜 모드는 서비스 발견기능을 자체 지원

- 클라이언트 → 서버 서비스(레플리카3개인경우)
    - 서버 서비스의 이름으로 요청가능, 이때 도커스웜 DNS에서 이를 자동으로 IP로 변환
    - 서비스이름은 어떻게 각 컨테이너의 IP로 변환될까? 서버라는 서비스네임이 3개의 IP를 가지는 것이 아니라 서비스의 VIP를 가지는 것. 
    즉 클라이언트에서 서버로 요청하게 되면 VIP 가상의 IP로 변환되고 해당 IP로의 요청이 실제 서비스 컨테이너의 IP로 포워딩

3.2.3.8 스웜 모드 볼륨

👉 volume 타입의 볼륨 생성

👉 bind 타입의 볼륨생성

👉 스웜 모드에서 볼륨의 한계점

스웜 모드에서 볼륨의 한계가 많기 때문에 사용하는 일반적인 방법은 퍼시스턴트 스토리지(호스트와 컨테이너와는 별개로 외부에 존재하며 네트워크로 마운트할 수 있는 스토리지)

이러한 퍼시스턴트 스토리지를 도커에서 자체적으로 제공하지는 않으므로 서드파티 플러그인을 사용하거나 nfs, dfs등을 별도로 구성해야 한다.

### 3.2.4 도커 스웜 모드 노드 다루기

3.2.4.1 노드 AVAILABILITY 변경하기

👉 Active

새로운 노드가 스웜 클러스터에 추가되면 기본적으로 설정되는 상태

👉 Drain

노드를 Drain 상태로 설정하면 스웜 매니저의 스케줄러는 컨테이너를 해당 노드에 할당하지 않음

일반적으로 매니저 노드에 설정하는 상태지만, 노드에 문제가 생겨 일시적으로 사용하지 않는 상태로 설정해야 할 때 주로 사용

👉 Pause

서비스의 컨테이너를 더는 할당받지 않는다는 점에서는 Drain과 같지만 실행 중인 컨테이너가 중지되지는 않는다는 점에서 다름

3.2.4.2 노드 라벨 추가

노드에 라벨을 추가하는 것은 노드를 분류하는 것과 비슷

👉 서비스 제약 설정

```bash
docker service create --name label_test \
--constraint 'node.labels.storage == ssd' \
--constraint 'node.id == adsakldajsdlads' \
--constraint 'node.hostname == adsakldajsdlads' \
--constraint 'node.role != manager' \

등 여러 제약조건을 통해 서비스의 컨테이너가 할당될 노드의 종류를 선택할 수 있다.
```